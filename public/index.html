<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>井字遊戲</title>
  <style>
    .hidden {
      opacity: 0;
      z-index: -1;
    }

    .screen {
      display: flex;
      align-items: center;
      flex-direction: column;
    }

    .box {
      position: relative;
      border-right: solid 1px black;
      height: 50px;
      width: 50px;

      &:last-child {
        border-right: none;
      }
    }

    .col-wrap {
      display: flex;
      width: 150px;
      border-bottom: solid 1px black;

      &:last-child {
        border-bottom: none;
      }
    }

    .noughts-box {
      &::before {
        content: '';
        display: block;
        width: 40px;
        height: 40px;
        position: absolute;
        top: 2.5px;
        left: 2.5px;
        border: solid 3px red;
        border-radius: 50%;
      }
    }

    .crosses-box {

      &::before,
      &::after {
        content: '';
        display: block;
        width: 40px;
        height: 4px;
        position: absolute;
        top: 50%;
        left: 50%;
        border-radius: 3px;
        background-color: blue;
      }

      &::before {
        transform: translate(-50%, -50%) rotate(45deg);
      }

      &::after {
        transform: translate(-50%, -50%) rotate(-45deg);
      }
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      display: flex;
      width: 100vw;
      height: 100vh;
      justify-content: center;
      align-items: center;
      background-color: rgba(0, 0, 0, 0.5);
    }
  </style>
</head>

<body>
  <h1>井字遊戲<span class="my-turn hidden">-換你</span></h1>
  <div>房間編號:<span class="room-number"></span></div>

  <div class="screen">
    <div class="col-wrap">
      <div id="box-0" class="box"></div>
      <div id="box-1" class="box"></div>
      <div id="box-2" class="box"></div>
    </div>
    <div class="col-wrap">
      <div id="box-3" class="box"></div>
      <div id="box-4" class="box"></div>
      <div id="box-5" class="box"></div>
    </div>
    <div class="col-wrap">
      <div id="box-6" class="box"></div>
      <div id="box-7" class="box"></div>
      <div id="box-8" class="box"></div>
    </div>
  </div>
  <div class="modal">
    <div>
      <p>創建遊戲</p>
      <button onclick="createRoom()">創建</button>
    </div>
    <div>
      <p>加入遊戲</p>
      <input type="text" id="room-number" placeholder="請輸入編號">
      <button onclick="joinRoom()">Send</button>
    </div>
  </div>
  <script>
    // 創建隨機四位數
    const createRoom = () => {
      const modal = document.querySelector('.modal')
      modal.classList.add('hidden')
      const roomNumber = Math.floor(1000 + Math.random() * 9000);
      ws.send(JSON.stringify({ event: 'createRoom', value: roomNumber }));
    }
    const joinRoom = () => {
      const modal = document.querySelector('.modal')
      modal.classList.add('hidden')
      const input = document.getElementById('room-number');
      ws.send(JSON.stringify({ event: 'joinRoom', value: input.value }));
      input.value = '';
    }
    // 閉包控制變數
    // const { myTurn, setMyTurn } = (() => {
    //   let myTurn = false
    //   return myTurn
    // })()
    // let myTurn = true;
    // ((global) => {
    const ws = new WebSocket(`wss://${window.location.host}`);

    // 文章中可補充測試用的 WebSocket 功能
    ws.onopen = () => {
      console.log('Connected to WebSocket server');
    };

    const playedEvent = (value) => {
      // document.getElementById(`box-${index}`).classList.add(`${classBox}-box`)
      gameState = value
      const boxList = document.getElementsByClassName('box')
      for (let i = 0; i < boxList.length; i++) {
        const boxState = gameState[i]
        boxList[i].classList.remove('crosses-box')
        boxList[i].classList.remove('noughts-box')
        boxList[i].classList.add(`${boxState}-box`)
      }
    }
    let myTurn = false;
    let roomNumber = null
    let classBox = null
    let gameState = null
    ws.onmessage = (message) => {
      const { event, value, ctl } = JSON.parse(message.data);
      switch (event) {
        case 'createdRoom':
          document.querySelector('.room-number').textContent = value
          roomNumber = value
          break;
        case 'joinedRoom':
          document.querySelector('.room-number').textContent = value
          roomNumber = value
          break;
        case 'start':
          classBox = value
          if (value === 'noughts') { myTurn = true }
          break;
        case 'action':
          myTurn = ctl
          playedEvent(value)
          break;
        case 'gameOver':
          myTurn = false
          alert(value)
          break;
        case 'error':
          alert(value)
          break;
        default:
          break;
      }
      ((value) => {
        if (!value) {
          document.querySelector('.my-turn').classList.add('hidden')
        } else {
          document.querySelector('.my-turn').classList.remove('hidden')
        }
      })(myTurn)
    };

    // 受點擊的盒子
    const querySelectorAll = document.querySelectorAll('.box');
    const boxClick = (element) => {
      if (myTurn) {
        const [, index] = element.target.id.split('-');
        ws.send(JSON.stringify({ event: 'action', value: index, classBox, roomNumber }));
      }
    }
    querySelectorAll.forEach(element => {
      element.addEventListener('click', boxClick);
    });
    // return sendMessage
    // })(this)
  </script>
</body>

</html>